= Projet : Application d'Inscription S√©curis√©e (PHP MVC & Crypto)
:toc: macro
:toc-title: Sommaire

Ce projet est un exercice complet de d√©veloppement web s√©curis√©. Il part d'une application PHP MVC simple pour aboutir √† une architecture complexe int√©grant du chiffrement hybride, une gestion de version professionnelle via SSH et une authentification moderne par Token (JWT).

toc::[]

== üéØ Contexte

Vous √™tes missionn√© par l'ENC pour d√©velopper le module d'inscription finale des nouveaux √©tudiants apr√®s Parcoursup.
L'application doit g√©rer :

* L'inscription et l'authentification des √©tudiants.
* La protection des mots de passe (Hachage).
* La confidentialit√© des donn√©es administratives (Chiffrement Sym√©trique).
* La confidentialit√© stricte des documents m√©dicaux (Chiffrement Hybride).
* **Nouveau :** Une authentification moderne sans session serveur (Stateless) via JWT.

== üìö Objectifs

√Ä la fin de ce cycle de TPs, vous ma√Ætrisez :

. **Architecture** : Structure MVC, s√©paration logique/donn√©es/vue.
. **S√©curit√© Web** : Diff√©rence entre Hachage (MDP) et Chiffrement (Donn√©es).
. **Cryptographie** :
** Sym√©trique (AES-256) pour les donn√©es textuelles.
** Hybride (AES + RSA) pour les fichiers volumineux.
. **Authentification** :
** Gestion des R√¥les (Admin, √âtudiant, Infirmi√®re).
** Transition Session (Stateful) vers JWT (Stateless).
. **DevOps** : Utilisation de cl√©s SSH pour l'authentification Git.

== üõ†Ô∏è Pr√©requis

* Serveur Web (Apache/Nginx) avec PHP 8+.
* Base de donn√©es MySQL/MariaDB.
* Extension PHP `openssl` activ√©e.
* Client Git.

== üìÇ Structure du Projet

[source,text]
----
/tp_enc_mvc/
|
|-- id_rsa_infirmerie          # üîë Cl√© Priv√©e (Sert √† d√©chiffrer - Simule le poste Infirmi√®re)
|-- id_rsa_infirmerie.pub      # üîë Cl√© Publique (Format SSH - Pour Git/Github)
|-- id_rsa_infirmerie_php.pem  # üîë Cl√© Publique (Format PEM - Convertie pour PHP OpenSSL)
|-- setup_keys.php             # üõ†Ô∏è Script pour g√©n√©rer/convertir les cl√©s.
|
|-- index.php                  # Contr√¥leur Frontal (Routeur + Middleware JWT)
|
|-- controller/
|   |-- etudiantController.php # G√®re Inscription, Auth, Dashboards.
|
|-- model/
|   |-- database.php           # Connexion BDD (PDO).
|   |-- etudiantModel.php      # CRUD √âtudiant + Documents Sant√© (BLOBs).
|
|-- services/                  # COUCHE CRYPTO & AUTH
|   |-- CryptoService.php      # Contient : encryptData (AES) & chiffreFichier (Hybride).
|   |-- JwtService.php         # <--- NOUVEAU (G√©n√©ration & V√©rification de Tokens).
|
|-- view/
|   |-- formulaireInscription.php
|   |-- adminDashboard.php
|   |-- infirmiereDashboard.php
|   ...
----

== üöÄ Historique des TPs

=== TP 1-3 : Les Fondations MVC & Auth
* Mise en place du **Mod√®le-Vue-Contr√¥leur**.
* S√©curisation des mots de passe avec `password_hash()` et `password_verify()`.

=== TP 4 : Confidentialit√© des Donn√©es (Sym√©trique)
* **Objectif :** Prot√©ger le "Num√©ro de Dossier".
* **M√©thode :** Chiffrement AES-256-CBC via `CryptoService`.
* **R√®gle m√©tier :** Seul l'administrateur peut voir le num√©ro d√©chiffr√©.

=== TP 5 : Documents M√©dicaux & Git (Hybride & SSH)
* **Chiffrement Hybride :** Utilisation d'une cl√© de session AES √©ph√©m√®re chiffr√©e par RSA pour prot√©ger les fichiers PDF m√©dicaux.
* **Authentification Git :** Utilisation de la m√™me paire de cl√©s RSA pour s'authentifier sur GitHub/GitLab.

=== TP 6 : Modernisation de l'Auth (JWT vs Sessions)
* **Objectif :** Remplacer les sessions serveur (`$_SESSION` / fichier `/tmp`) par une architecture **Stateless**.
* **Technologie :** JSON Web Token (JWT) stock√© dans un cookie `HttpOnly`.
* **M√©canisme :**
** Le serveur signe un jeton contenant les infos utilisateur (ID, R√¥le) avec un secret HMAC.
** Le client renvoie ce jeton √† chaque requ√™te via le cookie.
** Le serveur v√©rifie la signature math√©matique au lieu de chercher un fichier en m√©moire.

== üß† Sch√©ma de Synth√®se : Le Double Usage RSA

[source,text]
----
       UTILISATION DE LA PAIRE DE CL√âS RSA (INFIRMERIE)
       ================================================

   [ CONTEXTE 1 : Confidentialit√© ]           [ CONTEXTE 2 : Authenticit√© ]
      (TP PHP / Donn√©es M√©dicales)                  (TP GIT / SSH)
                 ‚îÇ                                        ‚îÇ
                 ‚ñº                                        ‚ñº
    +-------------------------+              +-------------------------+
    |   Donn√©e Sensible       |              |   Connexion Serveur     |
    |      (Fichier PDF)      |              |    (Github / Gitlab)    |
    +-----------+-------------+              +------------+------------+
                ‚îÇ                                         ‚îÇ
                ‚îÇ Chiffrement                             ‚îÇ Signature
                ‚îÇ (Cadenas)                               ‚îÇ (Sceau)
                ‚ñº                                         ‚ñº
      +-------------------+                     +-------------------+
      |   CL√â PUBLIQUE    |                     |    CL√â PRIV√âE     |
      | (id_rsa_inf.pub)  |                     | (id_rsa_infirmerie)|
      +-------------------+                     +-------------------+
                ‚îÇ                                         ‚îÇ
    "N'importe qui peut fermer                "Seul le propri√©taire
     le cadenas (chiffrer),                    peut apposer son sceau
     seul le priv√© l'ouvre."                   (prouver son identit√©)."
----

== üíª Commandes Utiles

=== G√©n√©ration des cl√©s (RSA)
[source,bash]
----
# G√©n√©ration de la cl√© priv√©e (Format PEM pour PHP)
ssh-keygen -t rsa -b 4096 -m PEM -f id_rsa_infirmerie -N ""

# Conversion de la cl√© publique pour PHP (Format PEM)
ssh-keygen -f id_rsa_infirmerie.pub -e -m PEM > id_rsa_infirmerie_php.pem
----

=== Configuration Git locale
[source,bash]
----
git config core.sshCommand "ssh -i ./id_rsa_infirmerie -F /dev/null"
----

== ‚ö†Ô∏è Avertissement de S√©curit√©

Dans ce TP  :

. Nous utilisons la m√™me cl√© pour signer nos commits et chiffrer des donn√©es (mauvaise pratique en prod).
. Le secret JWT est cod√© en dur dans le fichier PHP (devrait √™tre dans une variable d'environnement).
. Nous stockons le JWT dans un cookie (bonne pratique, mais attention au flag `HttpOnly`).