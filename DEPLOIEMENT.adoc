= TP Final : D√©ploiement DevOps & Mise en Production
:toc: macro
:toc-title: Sommaire
:icons: font

// Introduction
WARNING: **Derni√®re √©tape avant la scission SISR / SLAM !**
Ce TP final a pour but de professionnaliser notre application. Fini le "√ßa marche sur ma machine". Nous allons d√©ployer votre travail sur un v√©ritable serveur Linux accessible depuis internet, en utilisant des m√©thodes modernes (GitOps).

toc::[]

== üéØ Objectifs

* **SISR :** Administration serveur Linux, gestion des logs Apache/PHP, configuration SSH, gestion des variables d'environnement.
* **SLAM :** Adaptation du code pour la production ("12-Factor App"), d√©ploiement via Git, gestion des secrets.

== üõ†Ô∏è Pr√©requis

* Le projet `tp_enc_mvc` fonctionnel (avec JWT et Chiffrement Hybride).
* Votre d√©p√¥t GitHub/GitLab √† jour.
* Un terminal (Git Bash ou PowerShell).

---

== Partie 1 : Pr√©paration du Code (S√©curit√© & Environnement)

En DevOps, une r√®gle d'or est de **ne jamais stocker les mots de passe de production dans le code source**.
Si vous poussez un fichier contenant le mot de passe de la BDD de production sur GitHub, votre syst√®me est compromis.

Nous allons modifier l'application pour qu'elle r√©cup√®re sa configuration depuis les **Variables d'Environnement** du serveur.

=== 1.1 Modification de `model/database.php`

Ouvrez le fichier `model/database.php` et remplacez la fonction de connexion par celle-ci.
Elle utilise `getenv()` pour chercher la configuration. Si elle ne trouve rien (cas local Laragon), elle utilise les valeurs par d√©faut.

[source,php]
----
<?php
// Fichier : model/database.php

function getBdd() {
    // 1. On tente de lire les variables d'environnement (Config Serveur)
    // Si elles n'existent pas (?:), on prend les valeurs locales (Laragon)

    // Configuration Base de Donn√©es
    $host = getenv('DB_HOST') ?: 'localhost';
    $db   = getenv('DB_NAME') ?: 'tp_enc';
    $user = getenv('DB_USER') ?: 'root';
    $pass = getenv('DB_PASS') ?: '';

    // Configuration JWT (Secret)
    // On d√©finit la constante seulement si elle n'existe pas d√©j√†
    if (!defined('JWT_SECRET')) {
        $secret = getenv('JWT_SECRET') ?: 'ma_cle_secrete_locale_pour_le_dev_a_changer';
        define('JWT_SECRET', $secret);
    }

    try {
        $bdd = new PDO("mysql:host=$host;dbname=$db;charset=utf8", $user, $pass);
        $bdd->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        return $bdd;
    } catch (Exception $e) {
        // En production, on √©vite d'afficher $e->getMessage() directement aux utilisateurs
        // Mais pour ce TP, on le garde pour le d√©bogage.
        die('Erreur BDD : ' . $e->getMessage());
    }
}
----

=== 1.2 Mise √† jour du d√©p√¥t
Une fois le code modifi√© :

1.  Testez en local (Laragon) pour v√©rifier que vous n'avez rien cass√© (le fallback local doit fonctionner).
2.  Envoyez les modifications sur GitHub.

[source,bash]
----
git add model/database.php
git commit -m "feat: ajout support variables environnement"
git push origin master
----


== Partie 2 : Infrastructure (AlwaysData)

Nous allons utiliser **AlwaysData**, un h√©bergeur qui fournit un acc√®s **SSH** complet.

=== 2.1 Cr√©ation du compte et BDD
1.  Cr√©ez un compte gratuit sur https://www.alwaysdata.com (Pack 100 Mo gratuit).
2.  Dans l'interface d'administration, allez dans **Bases de donn√©es > MySQL**.
3.  Ajoutez un **Utilisateur** (notez bien le mot de passe !).
4.  Ajoutez une **Base de donn√©es** et liez-la √† l'utilisateur que vous venez de cr√©er.

=== 2.2 Configuration des Secrets (DevOps)
C'est ici que nous injectons la configuration de production sans toucher au code.

1.  Allez dans le menu **Environnement > Variables d'environnement**.
2.  Ajoutez les variables suivantes (avec VOS valeurs AlwaysData) :

|===
| Nom de la Variable | Valeur (Exemple)

| `DB_HOST`
| `mysql-votrecompte.alwaysdata.net` (Voir onglet MySQL)

| `DB_NAME`
| `votrecompte_projet`

| `DB_USER`
| `votrecompte_user`

| `DB_PASS`
| `LeMotDePasseQueVousAvezChoisi`

| `JWT_SECRET`
| `UnePhraseTresLongueEtAleatoirePourLaProd!`
|===

IMPORTANT: Ces informations sont maintenant s√©curis√©es dans la configuration du serveur et n'apparaissent nulle part dans votre code GitHub.

== Partie 3 : Le D√©ploiement (SSH & Git)

Oubliez FileZilla ! Nous allons agir comme des Administrateurs Syst√®me en prenant le contr√¥le du serveur √† distance.

=== 3.1 Connexion SSH
1.  Allez dans **Acc√®s distant > SSH** pour trouver votre commande de connexion.
2.  Ouvrez votre terminal (Git Bash) et connectez-vous.

[source,bash]
----
# Exemple (adaptez avec votre user)
ssh moncompte@ssh-moncompte.alwaysdata.net
----
_(Entrez votre mot de passe compte AlwaysData quand demand√©. Rien ne s'affiche quand vous tapez, c'est normal nous sommes sous Linux !)_

=== 3.2 Installation du Code
Une fois connect√© (√©cran noir), tapez les commandes suivantes :

[source,bash]
----
# 1. Se d√©placer dans le dossier public web
cd www

# 2. Nettoyer le dossier (Supprime le fichier 'default' d'AlwaysData)
rm -rf *

# 3. Cloner votre d√©p√¥t GitHub
# (N'oubliez pas l'espace et le POINT √† la fin pour cloner ICI)
git clone https://github.com/votre-pseudo/tp_enc_mvc.git .
----

=== 3.3 Importation de la Base de Donn√©es
Nous allons injecter votre script SQL directement depuis le terminal SSH.

[source,bash]
----
# Adaptez les valeurs : user, host et nom_bdd
mysql -u votre_user -p -h mysql-votrecompte.alwaysdata.net votre_nom_bdd < inscription_enc_avecChiffrementHybride.sql
----
_(Entrez le mot de passe de la BDD MySQL quand demand√©)._

=== 3.4 Transfert des "Secrets" (Cl√©s RSA)
[WARNING]
**GitHub a rejet√© votre push ? C'est une s√©curit√© !**
GitHub analyse votre code et a d√©tect√© des fichiers ressemblant √† des cl√©s priv√©es RSA. Il bloque le transfert pour √©viter qu'elles ne deviennent publiques.
**R√®gle d'or DevOps :** Les secrets (cl√©s priv√©es, mots de passe) ne sont JAMAIS stock√©s sur Git.

Nous allons donc envoyer ces fichiers manuellement de votre ordinateur vers le serveur via le protocole **SCP** (Secure Copy), qui utilise le m√™me canal s√©curis√© que SSH.

1.  Ouvrez un terminal sur votre ordinateur **local** (dans le dossier de votre projet).
2.  Rep√©rez vos 3 fichiers de cl√©s (Ex: `private.pem`, `public.pem`, etc.).
3.  Utilisez la commande suivante pour les "t√©l√©porter" sur le serveur :

[source,bash]
----
# Syntaxe : scp [fichiers] [utilisateur]@[hote]:[dossier_destination]

# Exemple (adaptez *.pem selon le nom de vos cl√©s) :
scp *.pem *.key moncompte@ssh-moncompte.alwaysdata.net:www/
----

4.  Entrez votre mot de passe SSH (le m√™me que pour la connexion pr√©c√©dente).
5.  Le terminal vous indiquera la progression du transfert (100%).

TIP: **Solution de secours :** Si la commande `scp` ne fonctionne pas chez vous, connectez-vous √† l'interface web d'AlwaysData, allez dans **Web > Sites > Gestionnaire de fichiers**, entrez dans le dossier `www` et utilisez le bouton **Envoyer** pour uploader vos cl√©s manuellement.

== Partie 4 : V√©rification et Debug (SISR)

=== 4.1 Test en direct
Ouvrez votre navigateur sur votre URL : `http://votre-compte.alwaysdata.net`.

* Essayez de vous inscrire.
* Connectez-vous en Admin.
* Connectez-vous en Infirmi√®re.
* **Test Ultime :** Uploadez un fichier m√©dical et essayez de le t√©l√©charger. Si le d√©chiffrement fonctionne, c'est que la cl√© priv√©e RSA est bien lue et que l'OpenSSL du serveur est actif !

=== 4.2 En cas d'erreur (Log Management)
Si vous avez une "Erreur 500" ou une page blanche : **Pas de panique, c'est le m√©tier qui rentre.**

Un administrateur ne devine pas, il lit les logs.
Sur AlwaysData, les logs d'erreurs HTTP se trouvent ici :

[source,bash]
----
# Dans le terminal SSH
cat $HOME/admin/logs/apache/error.log
----

Analysez les derni√®res lignes pour comprendre le probl√®me (souvent une erreur de connexion BDD ou un probl√®me de chemin de fichier).

== üéÅ Bonus : Automatisation (CI/CD)

Pour √©viter de taper `git clone` √† chaque modification, vous pouvez configurer AlwaysData pour qu'il mette √† jour le site automatiquement.

1.  Allez dans **Web > Sites > Modifier**.
2.  Cherchez la section **D√©ploiement automatique**.
3.  Liez votre compte GitHub et s√©lectionnez votre d√©p√¥t.

D√©sormais, un simple `git push` depuis votre ordinateur mettra √† jour le site de production en quelques secondes !

**Nous avons mis en place une cha√Æne de d√©ploiement professionnelle !**
----
